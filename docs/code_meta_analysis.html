<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />




<title>Code</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/flatly.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet" />
<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 60px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h2 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h3 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h4 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h5 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h6 {
  padding-top: 65px;
  margin-top: -65px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->



<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = false;
    options.smoothScroll = false;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}


.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
  padding-left: 25px;
  text-indent: 0;
}

.tocify .list-group-item {
  border-radius: 0px;
}

.tocify-subheader {
  display: inline;
}
.tocify-subheader .tocify-item {
  font-size: 0.95em;
}

</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Meta-analytical FHB model</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">
    <span class="fa fa fa fa-home"></span>
     
    About
  </a>
</li>
<li>
  <a href="data.html">
    <span class="fa fa fa fa-table"></span>
     
    Data
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa fa fa-file-code-o"></span>
     
    Documented analysis
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="code_meta_analysis.html">Meta-analysis approach</a>
    </li>
    <li>
      <a href="code_yield_loss.html">Yield loss modeling</a>
    </li>
    <li>
      <a href="code_fungicide_simulation.html">Fungicide costs</a>
    </li>
  </ul>
</li>
<li>
  <a href="plots.html">
    <span class="fa fa-bar-chart"></span>
     
    Publication-ready plots
  </a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Code</h1>

</div>


<pre class="r"><code>knitr::opts_chunk$set(echo = TRUE, warning = FALSE)</code></pre>
<div id="read-data" class="section level1">
<h1>Read data</h1>
<p>Let’s load the data prepared in the previous section and proceed with preparation for analysis.</p>
<pre class="r"><code>library(tidyverse)
fhb_dat &lt;- read.csv(&quot;data/fhb_data_new.csv&quot;) %&gt;%
  group_by(trial)</code></pre>
<div id="trial-level-linear-regression" class="section level2">
<h2>Trial-level linear regression</h2>
<p>Let’s now fit a regression model for each study with variable number of pairs of observations, but splitting the dataset according to the baseline yield, which will give 19 and 18 trials in each condition.</p>
<div id="high-yield-scenario" class="section level3">
<h3>High yield scenario</h3>
<pre class="r"><code>library(broom)

high_lm &lt;- fhb_dat %&gt;%
  filter(yield_class != &quot;low&quot;) %&gt;%
  group_by(trial) %&gt;%
  do(tidy(lm(.$yield ~ .$sev), conf.int = TRUE)) %&gt;%
  select(c(1:3)) %&gt;%
  spread(term, estimate)

high_lm1 &lt;- data.frame(high_lm)
colnames(high_lm1) &lt;- c(&quot;trial&quot;, &quot;intercept&quot;, &quot;slope&quot;)
summary(high_lm1)</code></pre>
<pre><code>##      trial         intercept           slope     
##  Min.   : 1.00   Min.   :-220.18   Min.   :3000  
##  1st Qu.: 6.50   1st Qu.: -75.40   1st Qu.:4124  
##  Median :17.50   Median : -53.35   Median :4433  
##  Mean   :16.44   Mean   : -60.86   Mean   :4473  
##  3rd Qu.:21.75   3rd Qu.: -18.57   3rd Qu.:4952  
##  Max.   :37.00   Max.   :  52.88   Max.   :6097</code></pre>
</div>
<div id="low-yield-scenario" class="section level3">
<h3>Low yield scenario</h3>
<pre class="r"><code>low_lm &lt;- fhb_dat %&gt;%
  filter(yield_class != &quot;high&quot;) %&gt;%
  group_by(trial) %&gt;%
  do(tidy(lm(.$yield ~ .$sev), conf.int = TRUE)) %&gt;%
  select(c(1:3)) %&gt;%
  spread(term, estimate)

low_lm1 &lt;- data.frame(low_lm)
colnames(low_lm1) &lt;- c(&quot;trial&quot;, &quot;intercept&quot;, &quot;slope&quot;)
head(low_lm1)</code></pre>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["trial"],"name":[1],"type":["int"],"align":["right"]},{"label":["intercept"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["slope"],"name":[3],"type":["dbl"],"align":["right"]}],"data":[{"1":"6","2":"-49.643709","3":"2463.242","_rn_":"1"},{"1":"7","2":"43.477198","3":"2752.433","_rn_":"2"},{"1":"8","2":"-381.866841","3":"3317.410","_rn_":"3"},{"1":"9","2":"-13.849251","3":"1768.866","_rn_":"4"},{"1":"10","2":"-0.189295","3":"2777.906","_rn_":"5"},{"1":"12","2":"-55.084217","3":"3157.509","_rn_":"6"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<pre class="r"><code>summary(low_lm1)</code></pre>
<pre><code>##      trial         intercept           slope     
##  Min.   : 6.00   Min.   :-381.87   Min.   :1708  
##  1st Qu.:11.00   1st Qu.: -82.11   1st Qu.:2579  
##  Median :24.00   Median : -54.02   Median :3102  
##  Mean   :21.42   Mean   : -71.76   Mean   :2977  
##  3rd Qu.:30.50   3rd Qu.: -17.10   3rd Qu.:3391  
##  Max.   :35.00   Max.   :  43.48   Max.   :4299</code></pre>
</div>
</div>
<div id="population-average-mixed-model-estimates" class="section level2">
<h2>Population-average mixed model estimates</h2>
<p>We will use the <code>lmer</code> function of the <code>lme4</code> to fit three different kinds of mixed models: random intercepts and slopes, random intercepts only and random slopes only. We also included baseline yield categorical variable in the model to check whether variance could be reduced, thus explaining portion of the variation in the slopes or intercepts.</p>
<pre class="r"><code>library(lme4)

# null model
mix_yld &lt;- lmer(yield ~ 1 + (1 | trial), data = fhb_dat, REML = F)

# random intercept and slopes
mix_yld1 &lt;- lmer(yield ~ sev + (sev | trial), data = fhb_dat, REML = F)

# random slopes
mix_yld2 &lt;- lmer(yield ~ sev + (1 | sev), data = fhb_dat, REML = F)

# random intercepts
mix_yld3 &lt;- lmer(yield ~ sev + (1 | trial), data = fhb_dat, REML = F)</code></pre>
<p>Here we can check which model best fitted the data based on the lowest AIC, which was the one with both intercepts and slopes as random effects.</p>
<pre class="r"><code>AIC(mix_yld, mix_yld1, mix_yld2, mix_yld3)</code></pre>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["df"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["AIC"],"name":[2],"type":["dbl"],"align":["right"]}],"data":[{"1":"3","2":"4817.058","_rn_":"mix_yld"},{"1":"6","2":"4624.178","_rn_":"mix_yld1"},{"1":"4","2":"5291.585","_rn_":"mix_yld2"},{"1":"4","2":"4683.390","_rn_":"mix_yld3"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<div id="effect-of-baseline-yield" class="section level3">
<h3>Effect of baseline yield</h3>
<p>Let’s include an interaction term and test whether variance was significantly reduced based on likelihood ratio test.</p>
<pre class="r"><code>mix_yld4 &lt;- lmer(yield ~ sev * yield_class + (sev | trial), data = fhb_dat, REML = F)</code></pre>
<pre class="r"><code>anova(mix_yld1, mix_yld4, test = &quot;Chisq&quot;)</code></pre>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["Df"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["AIC"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["BIC"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["logLik"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["deviance"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["Chisq"],"name":[6],"type":["dbl"],"align":["right"]},{"label":["Chi Df"],"name":[7],"type":["dbl"],"align":["right"]},{"label":["Pr(>Chisq)"],"name":[8],"type":["dbl"],"align":["right"]}],"data":[{"1":"6","2":"4624.178","3":"4646.732","4":"-2306.089","5":"4612.178","6":"NA","7":"NA","8":"NA","_rn_":"mix_yld1"},{"1":"8","2":"4595.092","3":"4625.163","4":"-2289.546","5":"4579.092","6":"33.08641","7":"2","8":"6.536987e-08","_rn_":"mix_yld4"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<pre class="r"><code>summary(mix_yld4)</code></pre>
<pre><code>## Linear mixed model fit by maximum likelihood  [&#39;lmerMod&#39;]
## Formula: yield ~ sev * yield_class + (sev | trial)
##    Data: fhb_dat
## 
##      AIC      BIC   logLik deviance df.resid 
##   4595.1   4625.2  -2289.5   4579.1      309 
## 
## Scaled residuals: 
##     Min      1Q  Median      3Q     Max 
## -6.1436 -0.3431  0.0492  0.4179  3.9299 
## 
## Random effects:
##  Groups   Name        Variance Std.Dev. Corr
##  trial    (Intercept) 372287   610.2        
##           sev           1129    33.6    0.02
##  Residual              57284   239.3        
## Number of obs: 317, groups:  trial, 37
## 
## Fixed effects:
##                     Estimate Std. Error t value
## (Intercept)         4419.504    148.390  29.783
## sev                  -46.316      9.604  -4.823
## yield_classlow     -1535.949    209.460  -7.333
## sev:yield_classlow    -3.475     14.309  -0.243
## 
## Correlation of Fixed Effects:
##             (Intr) sev    yld_cl
## sev         -0.087              
## yild_clsslw -0.708  0.062       
## sv:yld_clss  0.059 -0.671 -0.120
## convergence code: 0
## Model failed to converge with max|grad| = 0.0056379 (tol = 0.002, component 1)</code></pre>
<pre class="r"><code>library(emmeans)
CLD(emmeans(mix_yld4, ~ sev * yield_class))</code></pre>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["sev"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["yield_class"],"name":[2],"type":["fctr"],"align":["left"]},{"label":["emmean"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["SE"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["df"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["lower.CL"],"name":[6],"type":["dbl"],"align":["right"]},{"label":["upper.CL"],"name":[7],"type":["dbl"],"align":["right"]},{"label":[".group"],"name":[8],"type":["chr"],"align":["left"]}],"data":[{"1":"9.271626","2":"low","3":"2421.917","4":"171.6882","5":"41.78031","6":"2075.382","7":"2768.452","8":"1","_rn_":"2"},{"1":"9.271626","2":"high","3":"3990.081","4":"173.1156","5":"39.32240","6":"3640.014","7":"4340.149","8":"2","_rn_":"1"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<p>Extract the random coefficients (BLUES).</p>
<pre class="r"><code>blup &lt;- coef(mix_yld1)$trial
colnames(blup) &lt;- c(&quot;Intercept&quot;, &quot;Slope&quot;)

summary(blup)</code></pre>
<pre><code>##    Intercept        Slope         
##  Min.   :1620   Min.   :-112.534  
##  1st Qu.:2998   1st Qu.: -59.085  
##  Median :3560   Median : -52.881  
##  Mean   :3645   Mean   : -49.068  
##  3rd Qu.:4277   3rd Qu.: -23.605  
##  Max.   :5786   Max.   :  -4.544</code></pre>
<p>Calculate the interdecile range for the BLUEs of the slopes and intercepts</p>
<pre class="r"><code># Intercept
dec90_i &lt;- quantile(blup$Intercept, probs = c(.9))
dec10_i &lt;- quantile(blup$Intercept, probs = c(.1))
dec90_i - dec10_i</code></pre>
<pre><code>##      90% 
## 2470.569</code></pre>
<pre class="r"><code># Slopes
dec90_s &lt;- quantile(blup$Slope, probs = c(.9))
dec10_s &lt;- quantile(blup$Slope, probs = c(.1))
dec90_s - dec10_s</code></pre>
<pre><code>##      90% 
## 76.80005</code></pre>
</div>
</div>
</div>



Copyright 2017 Emerson Del Ponte


</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
